<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TB Detection Platform - Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        .hero-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 100px 0;
        }
        
        .service-card {
            transition: transform 0.3s ease;
            border: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .service-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
        }
        
        .feature-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-lungs me-2"></i>
                TB Detection Platform
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="#services">Services</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#about">About</a>
                    </li>
                    <li class="nav-item">
                        <span class="nav-link" id="userWelcome">Welcome, User!</span>
                    </li>
                    <li class="nav-item">
                        <button class="btn btn-outline-light btn-sm" onclick="logout()">
                            <i class="fas fa-sign-out-alt me-1"></i>Logout
                        </button>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <section id="home" class="hero-section">
        <div class="container text-center">
            <h1 class="display-4 mb-4">TB Detection Platform</h1>
            <p class="lead mb-5">AI-powered tuberculosis detection with 99.84% accuracy and intelligent health assistance</p>
            <a href="#services" class="btn btn-light btn-lg">
                <i class="fas fa-stethoscope me-2"></i>
                Explore Services
            </a>
        </div>
    </section>

    <!-- Services Section -->
    <section id="services" class="py-5">
        <div class="container">
            <div class="text-center mb-5">
                <h2 class="display-5">Our Services</h2>
                <p class="lead">Comprehensive healthcare solutions powered by artificial intelligence</p>
            </div>
            
            <div class="row g-4 justify-content-center">
                <!-- TB Detection -->
                <div class="col-md-6 col-lg-5">
                    <div class="card service-card h-100">
                        <div class="card-body text-center p-5">
                            <i class="fas fa-lungs text-primary feature-icon" style="font-size: 4rem; margin-bottom: 2rem;"></i>
                            <h4 class="card-title mb-3">TB Detection</h4>
                            <p class="card-text mb-4">Advanced AI model with 99.84% accuracy for tuberculosis detection from chest X-rays using PyTorch deep learning technology.</p>
                            <a href="/tb-detection" class="btn btn-primary btn-lg">
                                <i class="fas fa-upload me-2"></i>Start TB Detection
                            </a>
                        </div>
                    </div>
                </div>

                <!-- AI Health Assistant -->
                <div class="col-md-6 col-lg-5">
                    <div class="card service-card h-100">
                        <div class="card-body text-center p-5">
                            <i class="fas fa-robot text-success feature-icon" style="font-size: 4rem; margin-bottom: 2rem;"></i>
                            <h4 class="card-title mb-3">AI Health Assistant</h4>
                            <p class="card-text mb-4">Google Gemini-powered health assistant providing medical guidance, symptom analysis, and health recommendations.</p>
                            <a href="/ai-assistant" class="btn btn-success btn-lg">
                                <i class="fas fa-comments me-2"></i>Open AI Assistant
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- About Section -->
    <section id="about" class="py-5 bg-light">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-lg-6">
                    <h2 class="display-6 mb-4">About TB Detection Platform</h2>
                    <p class="lead">An advanced AI-powered platform specifically designed for accurate tuberculosis detection using state-of-the-art deep learning technology.</p>
                    <ul class="list-unstyled">
                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>99.84% accuracy in TB detection</li>
                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>PyTorch deep learning model</li>
                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>AI-powered health assistance</li>
                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Secure user authentication</li>
                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Fast and reliable analysis</li>
                    </ul>
                </div>
                <div class="col-lg-6">
                    <div class="text-center">
                        <i class="fas fa-hospital text-primary" style="font-size: 8rem; opacity: 0.1;"></i>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- API Status -->
    <section class="py-3 bg-dark text-white">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <h6>API Status</h6>
                    <div id="api-status">
                        <span class="badge bg-secondary">Checking...</span>
                    </div>
                </div>
                <div class="col-md-6 text-end">
                    <small>Backend API: <span id="api-url"></span></small>
                </div>
            </div>
        </div>
    </section>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Automatically detect if we're in development or production
        const API_BASE_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? 'http://127.0.0.1:5001/api'
            : `${window.location.protocol}//${window.location.host}/api`;
        
        // Set API URL display
        document.getElementById('api-url').textContent = API_BASE_URL.replace('/api', '');

        // Check API health on page load
        async function checkAPIHealth() {
            try {
                const response = await fetch(`${API_BASE_URL}/health`);
                const data = await response.json();
                
                if (data.status === 'healthy') {
                    document.getElementById('api-status').innerHTML = 
                        '<span class="badge bg-success">Online</span>';
                } else {
                    document.getElementById('api-status').innerHTML = 
                        '<span class="badge bg-warning">Partial</span>';
                }
            } catch (error) {
                document.getElementById('api-status').innerHTML = 
                    '<span class="badge bg-danger">Offline</span>';
            }
        }
        
        // Test individual services
        async function testService(service) {
            try {
                const response = await fetch(`${API_BASE_URL}/${service}/test`);
                const data = await response.json();
                
                alert(`${data.service}: ${data.status}`);
            } catch (error) {
                alert(`Service test failed: ${error.message}`);
            }
        }

        // Service Interface Functions
        function openTBDetection() {
            showServiceInterface('tb-detection', 'TB Detection', `
                <div class="row">
                    <div class="col-md-6">
                        <h5>Upload Chest X-Ray</h5>
                        <div class="mb-3">
                            <input type="file" class="form-control" id="tbImageUpload" accept="image/*">
                        </div>
                        <button class="btn btn-primary" onclick="analyzeTBImage()">
                            <i class="fas fa-search me-2"></i>Analyze X-Ray
                        </button>
                    </div>
                    <div class="col-md-6">
                        <h5>Analysis Result</h5>
                        <div id="tbResult" class="alert alert-info">
                            Upload an X-ray image to get tuberculosis detection results.
                        </div>
                    </div>
                </div>
            `);
        }

        function openHeartRateMonitor() {
            showServiceInterface('heart-rate', 'Heart Rate Monitor', `
                <div class="row">
                    <div class="col-md-6">
                        <h5>Camera-Based Detection</h5>
                        <video id="heartRateVideo" width="100%" height="200" autoplay style="border: 1px solid #ddd;"></video>
                        <div class="mt-2">
                            <button class="btn btn-danger" onclick="startHeartRateCamera()">
                                <i class="fas fa-camera me-2"></i>Start Camera
                            </button>
                            <button class="btn btn-secondary ms-2" onclick="stopHeartRateCamera()">
                                <i class="fas fa-stop me-2"></i>Stop
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h5>Manual Input</h5>
                        <div class="mb-3">
                            <label class="form-label">Heart Rate (BPM)</label>
                            <input type="number" class="form-control" id="manualHeartRate" placeholder="Enter heart rate">
                        </div>
                        <button class="btn btn-danger" onclick="analyzeHeartRate()">
                            <i class="fas fa-heartbeat me-2"></i>Analyze
                        </button>
                        <div id="heartRateResult" class="alert alert-info mt-3">
                            Enter heart rate or use camera to get analysis.
                        </div>
                    </div>
                </div>
            `);
        }

        function openAIAssistant() {
            showServiceInterface('ai-assistant', 'AI Health Assistant', `
                <div class="row">
                    <div class="col-12">
                        <div id="chatMessages" style="height: 400px; overflow-y: auto; border: 1px solid #ddd; padding: 15px; background: #f8f9fa;">
                            <div class="alert alert-info">
                                <i class="fas fa-robot me-2"></i>
                                Hello! I'm your AI Health Assistant. Ask me about symptoms, health concerns, or medical questions.
                            </div>
                        </div>
                        <div class="mt-3">
                            <div class="input-group">
                                <input type="text" class="form-control" id="chatInput" placeholder="Ask a health question..." onkeypress="if(event.key==='Enter') sendMessage()">
                                <button class="btn btn-success" onclick="sendMessage()">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `);
        }

        // Show service interface in a modal
        function showServiceInterface(serviceId, title, content) {
            const modalHtml = `
                <div class="modal fade" id="serviceModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">${title}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                ${content}
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Remove existing modal if any
            const existingModal = document.getElementById('serviceModal');
            if (existingModal) {
                existingModal.remove();
            }

            // Add new modal
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('serviceModal'));
            modal.show();
        }

        // Service-specific functions
        async function analyzeTBImage() {
            const fileInput = document.getElementById('tbImageUpload');
            const resultDiv = document.getElementById('tbResult');

            if (!fileInput.files[0]) {
                resultDiv.innerHTML = '<div class="alert alert-warning">Please select an image first.</div>';
                return;
            }

            resultDiv.innerHTML = '<div class="alert alert-info"><i class="fas fa-spinner fa-spin me-2"></i>Analyzing image...</div>';

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            try {
                const response = await fetch(`${API_BASE_URL}/tb-detection/upload`, {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();

                if (data.success) {
                    const confidence = (data.confidence * 100).toFixed(2);
                    const resultClass = data.prediction === 'tuberculosis' ? 'alert-danger' : 'alert-success';
                    resultDiv.innerHTML = `
                        <div class="alert ${resultClass}">
                            <h6>Analysis Complete</h6>
                            <p><strong>Prediction:</strong> ${data.prediction}</p>
                            <p><strong>Confidence:</strong> ${confidence}%</p>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `<div class="alert alert-danger">Error: ${data.error}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="alert alert-danger">Error analyzing image: ${error.message}</div>`;
            }
        }

        // Heart Rate Monitor Functions
        let heartRateStream = null;

        async function startHeartRateCamera() {
            try {
                heartRateStream = await navigator.mediaDevices.getUserMedia({ video: true });
                document.getElementById('heartRateVideo').srcObject = heartRateStream;

                // Simulate heart rate detection (in real implementation, this would use computer vision)
                setTimeout(() => {
                    const simulatedHeartRate = Math.floor(Math.random() * (100 - 60) + 60);
                    document.getElementById('heartRateResult').innerHTML = `
                        <div class="alert alert-info">
                            <h6>Camera Detection Result</h6>
                            <p><strong>Detected Heart Rate:</strong> ${simulatedHeartRate} BPM</p>
                            <p><strong>Status:</strong> ${getHeartRateStatus(simulatedHeartRate)}</p>
                        </div>
                    `;
                }, 3000);
            } catch (error) {
                document.getElementById('heartRateResult').innerHTML = `
                    <div class="alert alert-danger">Camera access denied: ${error.message}</div>
                `;
            }
        }

        function stopHeartRateCamera() {
            if (heartRateStream) {
                heartRateStream.getTracks().forEach(track => track.stop());
                document.getElementById('heartRateVideo').srcObject = null;
            }
        }

        async function analyzeHeartRate() {
            const heartRate = document.getElementById('manualHeartRate').value;
            const resultDiv = document.getElementById('heartRateResult');

            if (!heartRate) {
                resultDiv.innerHTML = '<div class="alert alert-warning">Please enter a heart rate value.</div>';
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/heart-rate/analyze`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ heart_rate: parseInt(heartRate) })
                });
                const data = await response.json();

                if (data.success) {
                    resultDiv.innerHTML = `
                        <div class="alert alert-info">
                            <h6>Analysis Result</h6>
                            <p><strong>Heart Rate:</strong> ${data.heart_rate} BPM</p>
                            <p><strong>Status:</strong> ${data.status}</p>
                            <p><strong>Zone:</strong> ${data.zone}</p>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `<div class="alert alert-danger">Error: ${data.error}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="alert alert-danger">Error analyzing heart rate: ${error.message}</div>`;
            }
        }

        function getHeartRateStatus(heartRate) {
            if (heartRate < 60) return "Bradycardia (Low)";
            if (heartRate > 100) return "Tachycardia (High)";
            return "Normal";
        }

        // AI Assistant Functions
        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();

            if (!message) return;

            const chatMessages = document.getElementById('chatMessages');

            // Add user message
            chatMessages.innerHTML += `
                <div class="mb-2">
                    <strong>You:</strong> ${message}
                </div>
            `;

            // Add loading message
            chatMessages.innerHTML += `
                <div class="mb-2" id="loadingMessage">
                    <strong>AI Assistant:</strong> <i class="fas fa-spinner fa-spin"></i> Thinking...
                </div>
            `;

            input.value = '';
            chatMessages.scrollTop = chatMessages.scrollHeight;

            try {
                const response = await fetch(`${API_BASE_URL}/ai-assistant/api/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: message })
                });
                const data = await response.json();

                // Remove loading message
                document.getElementById('loadingMessage').remove();

                if (data.success) {
                    chatMessages.innerHTML += `
                        <div class="mb-2">
                            <strong>AI Assistant:</strong> ${data.response}
                        </div>
                    `;
                } else {
                    chatMessages.innerHTML += `
                        <div class="mb-2 text-danger">
                            <strong>AI Assistant:</strong> Sorry, I encountered an error: ${data.error}
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('loadingMessage').remove();
                chatMessages.innerHTML += `
                    <div class="mb-2 text-danger">
                        <strong>AI Assistant:</strong> Sorry, I'm having trouble connecting. Please try again.
                    </div>
                `;
            }

            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Authentication functions
        function checkAuthentication() {
            const sessionToken = localStorage.getItem('session_token');
            const userData = localStorage.getItem('user_data');

            if (!sessionToken || !userData) {
                window.location.href = '/';
                return false;
            }

            // Update welcome message
            try {
                const user = JSON.parse(userData);
                document.getElementById('userWelcome').textContent = `Welcome, ${user.full_name}!`;
            } catch (e) {
                console.error('Error parsing user data');
            }

            return true;
        }

        function logout() {
            const sessionToken = localStorage.getItem('session_token');

            if (sessionToken) {
                // Call logout API
                fetch(`${API_BASE_URL}/auth/logout`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ session_token: sessionToken })
                }).catch(error => console.log('Logout API call failed'));
            }

            // Clear local storage
            localStorage.removeItem('session_token');
            localStorage.removeItem('user_data');

            // Redirect to landing page
            window.location.href = '/';
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Check authentication first
            if (!checkAuthentication()) {
                return;
            }

            checkAPIHealth();

            // Check API health every 30 seconds
            setInterval(checkAPIHealth, 30000);
        });
    </script>
</body>
</html>
